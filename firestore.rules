rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Obtener emails de administradores con fallback robusto
    function getAdminEmails() {
      // Por ahora usar configuración estática mientras implementamos la dinámica
      // TODO: Implementar lectura dinámica cuando la configuración esté estable
      return [
        'alexandersilvera@hotmail.com',
        'admin@centroumbandistareinodamata.org',
        'administrador@centroumbandistareinodamata.org'
      ];
    }
    
    // Verificar si el usuario es administrador
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.email in getAdminEmails();
    }
    
    // Verificar que el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Función auxiliar para validar datos de suscriptores
    function isValidSubscriber(data) {
      return data.keys().hasAll(['email', 'active']) &&
             data.email is string &&
             data.email.matches('.*@.*\\..*') &&
             data.active is bool;
    }
    
    // Reglas para artículos
    match /articles/{articleId} {
      // Permitir lectura a cualquier usuario (artículos públicos)
      allow read: if true;
      
      // Solo el administrador puede crear, actualizar y eliminar artículos
      allow create, update, delete: if isAdmin();
    }
    
    // Reglas para borradores
    match /drafts/{draftId} {
      // Solo el administrador puede leer, crear, actualizar y eliminar borradores
      allow read, write: if isAdmin();
    }
    
    // Reglas para perfiles de usuario
    match /userProfiles/{userId} {
      // Permitir lectura a todos los usuarios autenticados
      allow read: if isAuthenticated();
      
      // Permitir escritura solo al propio usuario o al administrador
      allow write: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }
    
    // Reglas para comentarios
    match /comments/{commentId} {
      // Permitir lectura a cualquier usuario
      allow read: if true;
      
      // Permitir crear comentarios solo a usuarios autenticados
      allow create: if isAuthenticated() && 
                    request.resource.data.userId == request.auth.uid;
      
      // Permitir eliminar solo al autor del comentario o al administrador
      allow delete: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || isAdmin());
      
      // Solo el administrador puede actualizar comentarios (moderación)
      allow update: if isAdmin();
    }
    
    // Reglas para suscriptores
    match /subscribers/{subscriberId} {
      // Solo el administrador puede leer todos los suscriptores
      allow read: if isAdmin();
      
      // Permitir crear suscriptores con validación de datos
      allow create: if isValidSubscriber(request.resource.data) &&
                    request.resource.data.email.size() > 0 &&
                    request.resource.data.email.size() <= 100;
      
      // Permitir actualizar solo para cancelar suscripción (campo active) o administración
      allow update: if isAdmin() || 
                    (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['active']) &&
                     request.resource.data.active == false);
      
      // Solo el administrador puede eliminar suscriptores
      allow delete: if isAdmin();
    }
    
    // Reglas para vistas de página (analytics básico)
    match /pageViews/{viewId} {
      // Permitir crear vistas a cualquier usuario (para analytics)
      allow create: if request.resource.data.keys().hasAll(['path', 'timestamp']) &&
                    request.resource.data.path is string &&
                    request.resource.data.path.size() > 0;
      
      // Solo el administrador puede leer analytics
      allow read: if isAdmin();
      
      // Solo el administrador puede actualizar/eliminar analytics
      allow update, delete: if isAdmin();
    }
    
    // Reglas para configuración del sitio
    match /siteConfig/{configId} {
      // Solo administradores pueden gestionar configuración
      allow read, write: if isAdmin();
    }

    // Reglas específicas para configuración de administradores
    match /siteConfig/adminEmails {
      // Permitir lectura a cualquier usuario autenticado (necesario para las reglas)
      allow read: if isAuthenticated();
      
      // Solo administradores pueden actualizar la configuración
      allow write: if isAdmin() && 
                   request.resource.data.keys().hasAll(['emails', 'lastUpdated', 'updatedBy']) &&
                   request.resource.data.emails is list &&
                   request.resource.data.emails.size() > 0 &&
                   request.resource.data.updatedBy is string;
    }
    
    // Reglas para sincronizaciones fallidas (solo lectura/escritura para admin)
    match /failed_syncs/{syncId} {
      // Solo administradores pueden leer y gestionar sincronizaciones fallidas
      allow read, write: if isAdmin();
    }
    
    // Reglas para errores de triggers (solo lectura/escritura para admin)
    match /trigger_errors/{errorId} {
      // Solo administradores pueden leer errores de triggers
      allow read, write: if isAdmin();
    }
    
    // Reglas para métricas de sincronización (solo lectura para admin)
    match /sync_metrics/{metricId} {
      // Solo administradores pueden leer métricas de sincronización
      allow read, write: if isAdmin();
    }
    
    // Reglas para roles de administrador (RBAC)
    match /admin_roles/{roleId} {
      // Solo los administradores pueden leer y escribir roles
      allow read, write: if isAdmin();
    }

    // ==========================================
    // NUEVAS REGLAS: SISTEMA DE MONETIZACIÓN
    // ==========================================

    // Reglas para planes de suscripción
    match /subscription_plans/{planId} {
      // Lectura pública de planes
      allow read: if true;

      // Solo administradores pueden crear/modificar planes
      allow create, update, delete: if isAdmin();
    }

    // Reglas para suscripciones de usuarios
    match /subscriptions/{subscriptionId} {
      // Usuario puede leer su propia suscripción o admin puede leer todas
      allow read: if isAuthenticated() &&
                   (resource.data.userId == request.auth.uid || isAdmin());

      // Solo admin puede crear/modificar suscripciones directamente
      allow create, update: if isAdmin();

      // Usuario puede cancelar su propia suscripción
      allow update: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid &&
                     request.resource.data.diff(resource.data).affectedKeys().hasOnly(['cancelAtPeriodEnd', 'updatedAt']) &&
                     request.resource.data.cancelAtPeriodEnd == true;

      // Solo admin puede eliminar
      allow delete: if isAdmin();
    }

    // Reglas para pagos
    match /payments/{paymentId} {
      // Usuario puede leer sus propios pagos o admin puede leer todos
      allow read: if isAuthenticated() &&
                   (resource.data.userId == request.auth.uid || isAdmin());

      // Solo sistema (via Cloud Functions) puede crear pagos
      allow create: if request.auth != null;

      // Solo admin puede actualizar/eliminar
      allow update, delete: if isAdmin();
    }

    // Reglas para registros de eventos académicos
    match /event_registrations/{registrationId} {
      // Usuario puede leer sus propios registros o admin puede leer todos
      allow read: if isAuthenticated() &&
                   (resource.data.userId == request.auth.uid || isAdmin());

      // Usuario autenticado puede registrarse a eventos
      allow create: if isAuthenticated() &&
                     request.resource.data.userId == request.auth.uid;

      // Usuario puede cancelar su propio registro
      allow update: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid &&
                     request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt']) &&
                     request.resource.data.status == 'cancelled';

      // Admin puede modificar cualquier registro
      allow update, delete: if isAdmin();
    }

    // Reglas para certificados digitales
    match /certificates/{certificateId} {
      // Usuario puede leer sus propios certificados o admin puede leer todos
      allow read: if isAuthenticated() &&
                   (resource.data.userId == request.auth.uid || isAdmin());

      // Solo sistema puede crear certificados
      allow create: if isAdmin();

      // Solo admin puede actualizar/eliminar
      allow update, delete: if isAdmin();
    }

    // Verificación pública de certificados (por código único)
    match /certificate_verifications/{verificationCode} {
      // Lectura pública para verificar autenticidad
      allow read: if true;

      // Solo sistema puede crear
      allow create: if isAdmin();

      // Solo admin puede modificar
      allow update, delete: if isAdmin();
    }

    // Reglas para biblioteca digital
    match /digital_library/{paperId} {
      // Lectura según nivel de acceso del documento
      allow read: if true; // Control de acceso en la lógica de negocio

      // Solo admin puede crear/modificar documentos
      allow create, update, delete: if isAdmin();
    }

    // Reglas para logs de acceso a documentos
    match /access_logs/{logId} {
      // Solo admin puede leer logs
      allow read: if isAdmin();

      // Sistema puede crear logs
      allow create: if isAuthenticated();

      // Solo admin puede modificar/eliminar
      allow update, delete: if isAdmin();
    }

    // Reglas para donaciones
    match /donations/{donationId} {
      // Admin puede leer todas las donaciones
      allow read: if isAdmin();

      // Usuario puede leer sus propias donaciones
      allow read: if isAuthenticated() &&
                   resource.data.userId == request.auth.uid;

      // Cualquiera puede crear donación (validación en Cloud Function)
      allow create: if request.resource.data.keys().hasAll(['amount', 'currency']) &&
                     request.resource.data.amount is number &&
                     request.resource.data.amount > 0 &&
                     request.resource.data.currency is string;

      // Solo admin puede modificar/eliminar
      allow update, delete: if isAdmin();
    }

    // Reglas para muro de donantes
    match /donor_wall/{donorId} {
      // Lectura pública del muro de donantes
      allow read: if true;

      // Solo sistema puede agregar al muro
      allow create: if isAdmin();

      // Solo admin puede modificar/eliminar
      allow update, delete: if isAdmin();
    }

    // Reglas para eventos académicos (ya existe en research pero agregamos control)
    match /academic-events/{eventId} {
      // Lectura pública de eventos
      allow read: if true;

      // Solo admin puede crear/modificar eventos
      allow create, update, delete: if isAdmin();
    }

    // Reglas para líneas de investigación
    match /research-lines/{lineId} {
      // Lectura pública
      allow read: if true;

      // Solo admin puede modificar
      allow create, update, delete: if isAdmin();
    }

    // Reglas para proyectos de investigación
    match /research-projects/{projectId} {
      // Lectura pública
      allow read: if true;

      // Solo admin puede modificar
      allow create, update, delete: if isAdmin();
    }

    // Reglas para papers de investigación
    match /research-papers/{paperId} {
      // Lectura pública
      allow read: if true;

      // Solo admin puede modificar
      allow create, update, delete: if isAdmin();
    }

    // Reglas para investigadores
    match /researchers/{researcherId} {
      // Lectura pública
      allow read: if true;

      // Solo admin puede modificar
      allow create, update, delete: if isAdmin();
    }

    // Regla por defecto - denegar acceso a cualquier otra colección
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 
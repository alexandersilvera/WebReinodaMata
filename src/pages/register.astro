---
import MainLayout from "@/layouts/MainLayout.astro";
import AuthSync from "@/components/AuthSync";

// Obtener el parámetro redirect de la URL
const redirectUrl = Astro.url.searchParams.get('redirect') || '';
const loginUrl = redirectUrl ? `/login?redirect=${encodeURIComponent(redirectUrl)}` : '/login';
---

<MainLayout title="Registrarse - Reino da Mata" description="Crea una nueva cuenta.">
  <!-- Componente para sincronización automática -->
  <AuthSync client:load />

  <div class="container mx-auto px-4 py-12 max-w-md">
    <h1 class="text-3xl font-bold text-center text-[#F08F4A] mb-4">Crear Cuenta</h1>
    <p class="text-center text-gray-400 mb-8 text-sm">Únete a la comunidad de Reino da Mata</p>

    <div class="bg-[#1f1e23] p-8 rounded-lg shadow-lg">
      <!-- Botón de Google como opción principal -->
      <button type="button" id="google-signin" class="w-full flex items-center justify-center gap-3 bg-white hover:bg-gray-100 text-gray-800 font-semibold py-3 px-4 rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg transform hover:scale-[1.02]">
        <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="24" height="24" viewBox="0 0 48 48">
          <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>
          <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
          <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.617-3.27-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>
          <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C43.021,36.697,44,34.008,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
        </svg>
        <span>Continuar con Google</span>
      </button>

      <!-- Separador -->
      <div class="flex items-center my-6">
        <hr class="flex-grow border-t border-gray-600">
        <span class="px-3 text-gray-400 text-sm">O regístrate con email</span>
        <hr class="flex-grow border-t border-gray-600">
      </div>

      <!-- Formulario tradicional -->
      <form id="register-form" class="space-y-5">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-300 mb-2" aria-label="Correo electrónico">
            Correo Electrónico
          </label>
          <div class="relative">
            <input
              type="email"
              id="email"
              name="email"
              required
              autocomplete="email"
              autofocus
              class="w-full px-4 py-2.5 pr-10 bg-[#2a292e] border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-[#F08F4A] focus:border-[#F08F4A] transition"
              placeholder="tu@email.com"
              aria-describedby="email-status"
            >
            <div id="email-status" class="absolute right-3 top-1/2 transform -translate-y-1/2 hidden">
              <svg id="email-valid-icon" class="w-5 h-5 text-green-500 hidden" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <svg id="email-invalid-icon" class="w-5 h-5 text-red-500 hidden" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
              </svg>
            </div>
          </div>
          <div class="flex items-center mt-2">
            <label class="flex items-center text-sm text-gray-400 cursor-pointer hover:text-gray-300">
              <input type="checkbox" id="remember-email" name="remember-email" checked class="mr-2 rounded border-gray-600 bg-[#2a292e] text-[#F08F4A] focus:ring-[#F08F4A]">
              <span>Recordar mi email</span>
            </label>
          </div>
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-300 mb-2" aria-label="Contraseña">
            Contraseña
          </label>
          <div class="relative">
            <input
              type="password"
              id="password"
              name="password"
              required
              minlength="8"
              autocomplete="new-password"
              class="w-full px-4 py-2.5 pr-10 bg-[#2a292e] border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-[#F08F4A] focus:border-[#F08F4A] transition"
              placeholder="Mínimo 8 caracteres"
              aria-describedby="caps-lock-warning password-requirements"
            >
            <button
              type="button"
              id="toggle-password"
              class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-300 transition"
              aria-label="Mostrar u ocultar contraseña"
            >
              <svg id="eye-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
              <svg id="eye-off-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
              </svg>
            </button>
          </div>

          <!-- Indicador de Caps Lock -->
          <div id="caps-lock-warning" class="mt-2 text-xs text-yellow-500 hidden flex items-center gap-1" role="alert">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <span>Mayúsculas activadas</span>
          </div>

          <!-- Indicador de fuerza de contraseña -->
          <div id="password-strength" class="mt-2 hidden">
            <div class="flex gap-1 mb-1">
              <div id="strength-bar-1" class="h-1 flex-1 bg-gray-600 rounded transition-colors"></div>
              <div id="strength-bar-2" class="h-1 flex-1 bg-gray-600 rounded transition-colors"></div>
              <div id="strength-bar-3" class="h-1 flex-1 bg-gray-600 rounded transition-colors"></div>
              <div id="strength-bar-4" class="h-1 flex-1 bg-gray-600 rounded transition-colors"></div>
            </div>
            <p id="strength-text" class="text-xs text-gray-400"></p>
          </div>

          <!-- Requisitos de contraseña -->
          <ul id="password-requirements" class="mt-2 text-xs space-y-1 hidden">
            <li id="req-length" class="text-gray-400">✗ Mínimo 8 caracteres</li>
            <li id="req-uppercase" class="text-gray-400">✗ Una letra mayúscula</li>
            <li id="req-number" class="text-gray-400">✗ Un número</li>
            <li id="req-special" class="text-gray-400">✗ Un carácter especial</li>
          </ul>
        </div>

        <div>
          <label for="confirm-password" class="block text-sm font-medium text-gray-300 mb-2" aria-label="Confirmar contraseña">
            Confirmar Contraseña
          </label>
          <div class="relative">
            <input
              type="password"
              id="confirm-password"
              name="confirm-password"
              required
              minlength="8"
              autocomplete="new-password"
              class="w-full px-4 py-2.5 pr-10 bg-[#2a292e] border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-[#F08F4A] focus:border-[#F08F4A] transition"
              placeholder="Repite la contraseña"
            >
            <button
              type="button"
              id="toggle-confirm-password"
              class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-300 transition"
              aria-label="Mostrar u ocultar confirmación de contraseña"
            >
              <svg id="eye-icon-confirm" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
              <svg id="eye-off-icon-confirm" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
              </svg>
            </button>
          </div>
          <div id="password-match-indicator" class="mt-2 text-xs hidden"></div>
        </div>

        <button
          type="submit"
          id="submit-button"
          class="w-full bg-[#F08F4A] hover:bg-[#D9734E] text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98]"
          aria-label="Registrarse"
        >
          <span id="submit-text">Crear Cuenta</span>
          <span id="submit-loader" class="hidden">
            <svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </span>
        </button>

        <div id="error-message" class="text-sm mt-4 text-center hidden"></div>
        <div id="success-message" class="text-sm mt-4 text-center hidden"></div>

        <p class="text-center text-sm text-gray-400 mt-6">
          ¿Ya tienes cuenta? <a href={loginUrl} class="text-[#F08F4A] hover:underline font-medium transition">Inicia sesión aquí</a>
        </p>
      </form>
    </div>
  </div>
</MainLayout>

<script>
  import { createUserWithEmailAndPassword, sendEmailVerification, GoogleAuthProvider, signInWithPopup } from "firebase/auth";
  import { auth } from "@/core/firebase/config";
  import { isBlocked, recordFailedAttempt, recordSuccessfulAttempt, formatBlockTime } from "../core/auth/rateLimiter.js";
  import { trackAuthEvent } from "../core/auth/authAnalytics.js";

  // Elementos del DOM
  const registerForm = document.getElementById('register-form') as HTMLFormElement;
  const emailInput = document.getElementById('email') as HTMLInputElement;
  const passwordInput = document.getElementById('password') as HTMLInputElement;
  const confirmPasswordInput = document.getElementById('confirm-password') as HTMLInputElement;
  const rememberEmailCheckbox = document.getElementById('remember-email') as HTMLInputElement;
  const submitButton = document.getElementById('submit-button') as HTMLButtonElement;
  const submitText = document.getElementById('submit-text') as HTMLSpanElement;
  const submitLoader = document.getElementById('submit-loader') as HTMLSpanElement;
  const errorMessageDiv = document.getElementById('error-message') as HTMLDivElement;
  const successMessageDiv = document.getElementById('success-message') as HTMLDivElement;
  const googleSignInButton = document.getElementById('google-signin') as HTMLButtonElement;

  // Toggle password
  const togglePasswordButton = document.getElementById('toggle-password') as HTMLButtonElement;
  const eyeIcon = document.getElementById('eye-icon')!;
  const eyeOffIcon = document.getElementById('eye-off-icon')!;
  const toggleConfirmPasswordButton = document.getElementById('toggle-confirm-password') as HTMLButtonElement;
  const eyeIconConfirm = document.getElementById('eye-icon-confirm')!;
  const eyeOffIconConfirm = document.getElementById('eye-off-icon-confirm')!;

  // Caps Lock
  const capsLockWarning = document.getElementById('caps-lock-warning') as HTMLDivElement;

  // Email validation
  const emailStatus = document.getElementById('email-status') as HTMLDivElement;
  const emailValidIcon = document.getElementById('email-valid-icon')!;
  const emailInvalidIcon = document.getElementById('email-invalid-icon')!;

  // Password strength
  const strengthContainer = document.getElementById('password-strength')!;
  const strengthBars = [
    document.getElementById('strength-bar-1')!,
    document.getElementById('strength-bar-2')!,
    document.getElementById('strength-bar-3')!,
    document.getElementById('strength-bar-4')!,
  ];
  const strengthText = document.getElementById('strength-text')!;
  const requirementsContainer = document.getElementById('password-requirements')!;
  const reqLength = document.getElementById('req-length')!;
  const reqUppercase = document.getElementById('req-uppercase')!;
  const reqNumber = document.getElementById('req-number')!;
  const reqSpecial = document.getElementById('req-special')!;

  // Password match indicator
  const passwordMatchIndicator = document.getElementById('password-match-indicator')!;

  // Constantes para localStorage
  const STORAGE_KEY = 'reino_da_mata_remembered_email';

  // ==================== SISTEMA DE RECORDAR EMAIL ====================
  function loadRememberedEmail() {
    const savedEmail = localStorage.getItem(STORAGE_KEY);
    if (savedEmail) {
      emailInput.value = savedEmail;
      validateEmail(savedEmail);
    }
  }

  function saveEmail(email: string) {
    if (rememberEmailCheckbox.checked) {
      localStorage.setItem(STORAGE_KEY, email);
    } else {
      localStorage.removeItem(STORAGE_KEY);
    }
  }

  // ==================== VALIDACIÓN DE EMAIL EN TIEMPO REAL ====================
  function validateEmail(email: string): boolean {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const isValid = emailRegex.test(email);

    if (email.length > 0) {
      emailStatus.classList.remove('hidden');
      if (isValid) {
        emailValidIcon.classList.remove('hidden');
        emailInvalidIcon.classList.add('hidden');
        emailInput.classList.remove('border-red-500');
        emailInput.classList.add('border-green-500');
      } else {
        emailValidIcon.classList.add('hidden');
        emailInvalidIcon.classList.remove('hidden');
        emailInput.classList.add('border-red-500');
        emailInput.classList.remove('border-green-500');
      }
    } else {
      emailStatus.classList.add('hidden');
      emailInput.classList.remove('border-red-500', 'border-green-500');
    }

    return isValid;
  }

  emailInput.addEventListener('input', () => {
    validateEmail(emailInput.value);
  });

  // ==================== MOSTRAR/OCULTAR CONTRASEÑAS ====================
  let passwordVisible = false;
  let confirmPasswordVisible = false;

  togglePasswordButton.addEventListener('click', () => {
    passwordVisible = !passwordVisible;
    passwordInput.type = passwordVisible ? 'text' : 'password';

    if (passwordVisible) {
      eyeIcon.classList.add('hidden');
      eyeOffIcon.classList.remove('hidden');
    } else {
      eyeIcon.classList.remove('hidden');
      eyeOffIcon.classList.add('hidden');
    }
  });

  toggleConfirmPasswordButton.addEventListener('click', () => {
    confirmPasswordVisible = !confirmPasswordVisible;
    confirmPasswordInput.type = confirmPasswordVisible ? 'text' : 'password';

    if (confirmPasswordVisible) {
      eyeIconConfirm.classList.add('hidden');
      eyeOffIconConfirm.classList.remove('hidden');
    } else {
      eyeIconConfirm.classList.remove('hidden');
      eyeOffIconConfirm.classList.add('hidden');
    }
  });

  // ==================== DETECCIÓN DE CAPS LOCK ====================
  passwordInput.addEventListener('keyup', (e) => {
    const isCapsLock = e.getModifierState && e.getModifierState('CapsLock');
    capsLockWarning.classList.toggle('hidden', !isCapsLock);
  });

  confirmPasswordInput.addEventListener('keyup', (e) => {
    const isCapsLock = e.getModifierState && e.getModifierState('CapsLock');
    capsLockWarning.classList.toggle('hidden', !isCapsLock);
  });

  // ==================== NAVEGACIÓN CON ENTER ====================
  emailInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      passwordInput.focus();
    }
  });

  passwordInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      confirmPasswordInput.focus();
    }
  });

  // ==================== VALIDACIÓN DE CONTRASEÑA ====================
  function validatePassword(password: string) {
    const requirements = {
      length: password.length >= 8,
      uppercase: /[A-Z]/.test(password),
      number: /[0-9]/.test(password),
      special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password),
    };

    reqLength.textContent = requirements.length ? '✓ Mínimo 8 caracteres' : '✗ Mínimo 8 caracteres';
    reqLength.className = requirements.length ? 'text-green-500' : 'text-gray-400';

    reqUppercase.textContent = requirements.uppercase ? '✓ Una letra mayúscula' : '✗ Una letra mayúscula';
    reqUppercase.className = requirements.uppercase ? 'text-green-500' : 'text-gray-400';

    reqNumber.textContent = requirements.number ? '✓ Un número' : '✗ Un número';
    reqNumber.className = requirements.number ? 'text-green-500' : 'text-gray-400';

    reqSpecial.textContent = requirements.special ? '✓ Un carácter especial' : '✗ Un carácter especial';
    reqSpecial.className = requirements.special ? 'text-green-500' : 'text-gray-400';

    const met = Object.values(requirements).filter(Boolean).length;
    let strength = 0;
    let strengthLabel = '';
    let color = '';

    if (met === 0) {
      strength = 0;
      strengthLabel = '';
    } else if (met === 1) {
      strength = 1;
      strengthLabel = 'Muy débil';
      color = 'bg-red-500';
    } else if (met === 2) {
      strength = 2;
      strengthLabel = 'Débil';
      color = 'bg-orange-500';
    } else if (met === 3) {
      strength = 3;
      strengthLabel = 'Buena';
      color = 'bg-yellow-500';
    } else if (met === 4) {
      strength = 4;
      strengthLabel = 'Fuerte';
      color = 'bg-green-500';
    }

    strengthBars.forEach((bar, index) => {
      bar.className = `h-1 flex-1 rounded transition-colors ${index < strength ? color : 'bg-gray-600'}`;
    });

    strengthText.textContent = strengthLabel;

    return { requirements, strength, valid: met === 4 };
  }

  passwordInput.addEventListener('focus', () => {
    strengthContainer.classList.remove('hidden');
    requirementsContainer.classList.remove('hidden');
  });

  passwordInput.addEventListener('input', () => {
    validatePassword(passwordInput.value);
    checkPasswordMatch();
  });

  // ==================== VERIFICAR COINCIDENCIA DE CONTRASEÑAS ====================
  function checkPasswordMatch() {
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;

    if (confirmPassword.length > 0) {
      passwordMatchIndicator.classList.remove('hidden');

      if (password === confirmPassword) {
        passwordMatchIndicator.innerHTML = '<span class="text-green-500 flex items-center gap-1"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg> Las contraseñas coinciden</span>';
        confirmPasswordInput.classList.remove('border-red-500');
        confirmPasswordInput.classList.add('border-green-500');
      } else {
        passwordMatchIndicator.innerHTML = '<span class="text-red-500 flex items-center gap-1"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg> Las contraseñas no coinciden</span>';
        confirmPasswordInput.classList.add('border-red-500');
        confirmPasswordInput.classList.remove('border-green-500');
      }
    } else {
      passwordMatchIndicator.classList.add('hidden');
      confirmPasswordInput.classList.remove('border-red-500', 'border-green-500');
    }
  }

  confirmPasswordInput.addEventListener('input', checkPasswordMatch);

  // ==================== MENSAJES DE ERROR/ÉXITO MEJORADOS ====================
  function showError(message: string) {
    errorMessageDiv.innerHTML = `
      <div class="flex items-center justify-center gap-2 text-red-500 bg-red-500/10 border border-red-500/30 rounded-lg p-3">
        <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
        <span>${message}</span>
      </div>
    `;
    errorMessageDiv.classList.remove('hidden');
    successMessageDiv.classList.add('hidden');
  }

  function showSuccess(message: string) {
    successMessageDiv.innerHTML = `
      <div class="flex items-center justify-center gap-2 text-green-500 bg-green-500/10 border border-green-500/30 rounded-lg p-3">
        <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
        <span>${message}</span>
      </div>
    `;
    successMessageDiv.classList.remove('hidden');
    errorMessageDiv.classList.add('hidden');
  }

  function hideMessages() {
    errorMessageDiv.classList.add('hidden');
    successMessageDiv.classList.add('hidden');
  }

  function setLoadingState(isLoading: boolean) {
    submitButton.disabled = isLoading;
    googleSignInButton.disabled = isLoading;

    if (isLoading) {
      submitText.classList.add('hidden');
      submitLoader.classList.remove('hidden');
    } else {
      submitText.classList.remove('hidden');
      submitLoader.classList.add('hidden');
    }
  }

  // ==================== VERIFICACIÓN DE BLOQUEO ====================
  function checkBlockStatus() {
    const blockStatus = isBlocked('register');
    if (blockStatus.blocked && blockStatus.remainingTime) {
      submitButton.disabled = true;
      googleSignInButton.disabled = true;
      showError(`Demasiados intentos de registro. Intenta de nuevo en ${formatBlockTime(blockStatus.remainingTime)}.`);

      const interval = setInterval(() => {
        const newStatus = isBlocked('register');
        if (!newStatus.blocked) {
          clearInterval(interval);
          submitButton.disabled = false;
          googleSignInButton.disabled = false;
          hideMessages();
        } else if (newStatus.remainingTime) {
          showError(`Demasiados intentos de registro. Intenta de nuevo en ${formatBlockTime(newStatus.remainingTime)}.`);
        }
      }, 1000);
    }
  }

  function handleRedirect() {
    showSuccess('¡Cuenta creada exitosamente! Redirigiendo...');
    setTimeout(() => {
      window.location.href = '/verify-email';
    }, 800);
  }

  // ==================== GOOGLE SIGN-UP ====================
  googleSignInButton.addEventListener('click', async () => {
    const blockStatus = isBlocked('register_google');
    if (blockStatus.blocked) {
      showError('Demasiados intentos con Google. Intenta más tarde.');
      return;
    }

    setLoadingState(true);
    hideMessages();

    const provider = new GoogleAuthProvider();
    try {
      await signInWithPopup(auth, provider);
      recordSuccessfulAttempt('register_google');
      trackAuthEvent('register_google', true, { provider: 'google' });

      showSuccess('¡Registro exitoso! Redirigiendo...');
      setTimeout(() => {
        window.location.href = '/';
      }, 800);
    } catch (error: any) {
      console.error("Error con Google Sign-Up:", error);
      const result = recordFailedAttempt('register_google');
      trackAuthEvent('register_google', false, { errorCode: error.code, blocked: result.blocked });

      let friendlyMessage = 'No se pudo registrar con Google. Inténtalo de nuevo.';
      if (error.code === 'auth/popup-closed-by-user') {
        friendlyMessage = 'El proceso de registro fue cancelado.';
      } else if (error.code === 'auth/email-already-in-use') {
        friendlyMessage = 'Este correo ya está en uso. Intenta iniciar sesión.';
      } else if (error.code === 'auth/popup-blocked') {
        friendlyMessage = 'El popup fue bloqueado por tu navegador. Por favor, permite los popups para este sitio.';
      }

      showError(friendlyMessage);
      setLoadingState(false);
    }
  });

  // ==================== REGISTRO CON EMAIL/CONTRASEÑA ====================
  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const blockStatus = isBlocked('register');
    if (blockStatus.blocked) {
      return;
    }

    // Validar email
    if (!validateEmail(emailInput.value)) {
      showError('Por favor, ingresa un correo electrónico válido.');
      emailInput.focus();
      return;
    }

    const email = emailInput.value;
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;

    // Validar contraseña
    const validation = validatePassword(password);
    if (!validation.valid) {
      showError('La contraseña no cumple con todos los requisitos de seguridad.');
      passwordInput.focus();
      return;
    }

    if (password !== confirmPassword) {
      showError('Las contraseñas no coinciden.');
      confirmPasswordInput.focus();
      return;
    }

    hideMessages();
    setLoadingState(true);

    try {
      // Guardar email si está marcado
      saveEmail(email);

      const userCredential = await createUserWithEmailAndPassword(auth, email, password);

      recordSuccessfulAttempt('register');
      trackAuthEvent('register_email', true);

      // Enviar email de verificación
      try {
        await sendEmailVerification(userCredential.user);
        console.log('[Register] Email de verificación enviado a:', email);
      } catch (verifyError) {
        console.error('[Register] Error al enviar email de verificación:', verifyError);
      }

      handleRedirect();
    } catch (error: any) {
      console.error("Registration error:", error);

      const result = recordFailedAttempt('register');
      trackAuthEvent('register_email', false, { errorCode: error.code, blocked: result.blocked });

      let friendlyMessage = "Error al registrar la cuenta. Inténtalo de nuevo.";
      if (error.code === 'auth/email-already-in-use') {
        friendlyMessage = "Este correo electrónico ya está registrado. Intenta iniciar sesión.";
      } else if (error.code === 'auth/weak-password') {
        friendlyMessage = "La contraseña es demasiado débil.";
      } else if (error.code === 'auth/invalid-email') {
        friendlyMessage = "El formato del correo electrónico no es válido.";
      } else if (error.code === 'auth/too-many-requests') {
        friendlyMessage = "Demasiados intentos. Por favor, espera un momento antes de intentar nuevamente.";
      }

      if (result.blocked) {
        friendlyMessage = "Demasiados intentos de registro. Tu acceso ha sido bloqueado temporalmente por 15 minutos.";
        checkBlockStatus();
      }

      showError(friendlyMessage);
      setLoadingState(false);
    }
  });

  // ==================== INICIALIZACIÓN ====================
  checkBlockStatus();
  loadRememberedEmail();
</script>

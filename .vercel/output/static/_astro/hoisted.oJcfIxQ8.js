import{i as U,b as y,k as ae,s as C,d as z,l as se,m as me,g as ge,q as P,w as H,n as O,h as fe,o as pe,a as F,T as Ee,f as he}from"./config.DlMdeYpO.js";import"https://unpkg.com/react-dom@18/umd/react-dom.development.js";import"https://unpkg.com/react@18/umd/react.development.js";import"https://cdn.jsdelivr.net/npm/dompurify@2.3.4/dist/purify.min.js";import"https://cdn.jsdelivr.net/npm/marked/marked.min.js";import"./hoisted.D3FFN0QM.js";const ie="articles",x="drafts",ye=async e=>{try{const t=U(y,ie);return(await ae(t,{...e,createdAt:C(),updatedAt:C()})).id}catch(t){throw console.error("Error al crear artículo:",t),t}},ce=async(e,t)=>{try{console.log("[CLEANUP_DRAFTS] Limpiando borradores antiguos con slug:",e,"excepto:",t);const r=U(y,x),o=P(r,H("slug","==",e)),s=(await O(o)).docs.filter(g=>g.id!==t);console.log("[CLEANUP_DRAFTS] Borradores a eliminar:",s.length);const l=s.map(g=>(console.log("[CLEANUP_DRAFTS] Eliminando borrador:",g.id),se(g.ref)));await Promise.all(l),console.log("[CLEANUP_DRAFTS] Limpieza completada")}catch(r){console.error("Error al limpiar borradores antiguos:",r)}},le=async(e,t)=>{try{let r;if(t){const o=z(y,x,t);await me(o,{...e,updatedAt:C()},{merge:!0}),r=t}else{const o=U(y,x);r=(await ae(o,{...e,createdAt:C(),updatedAt:C()})).id}return e.slug&&await ce(e.slug,r),r}catch(r){throw console.error("Error al guardar borrador:",r),r}},ve=async e=>{try{const t=z(y,x,e),r=await ge(t);return r.exists()?{id:r.id,...r.data()}:null}catch(t){throw console.error("Error al obtener borrador:",t),t}},de=async e=>{try{const t=z(y,x,e);await se(t)}catch(t){throw console.error("Error al eliminar borrador:",t),t}},be=async(e,t)=>{try{console.log("[CHECK_SLUG_EXISTS] Verificando slug:",e,"excludeId:",t);const r=U(y,ie),o=P(r,H("slug","==",e)),a=await O(o);console.log("[CHECK_SLUG_EXISTS] Artículos encontrados:",a.docs.length),a.docs.forEach(u=>{console.log("[CHECK_SLUG_EXISTS] Artículo:",u.id,"slug:",u.data().slug)});const s=a.docs.some(u=>u.id!==t);if(console.log("[CHECK_SLUG_EXISTS] Existe en artículos (después de excluir):",s),s)return!0;const l=U(y,x),g=P(l,H("slug","==",e)),f=await O(g);console.log("[CHECK_SLUG_EXISTS] Borradores encontrados:",f.docs.length),f.docs.forEach(u=>{console.log("[CHECK_SLUG_EXISTS] Borrador:",u.id,"slug:",u.data().slug,"excluido?:",u.id===t)});const b=f.docs.some(u=>u.id!==t);return console.log("[CHECK_SLUG_EXISTS] Existe en borradores (después de excluir):",b),b}catch(r){throw console.error("Error al verificar slug:",r),r}},Le=fe(he,"syncContentToFiles");let n={title:"",slug:"",author:"",image:"",description:"",tags:[],content:"",draft:!1,commentsEnabled:!0,featured:!1},c=!1,D=null,p=null;const K=document.getElementById("loading"),X=document.getElementById("article-form-container"),A=document.getElementById("article-form"),M=document.getElementById("success-message"),T=document.getElementById("sync-message"),k=document.getElementById("sync-status"),w=document.getElementById("sync-content-btn"),B=document.getElementById("error-message"),R=document.getElementById("error-details"),j=document.getElementById("view-article-link"),Q=document.getElementById("preview-btn"),W=document.getElementById("save-draft-btn"),L=document.getElementById("submit-btn"),m=document.getElementById("preview-modal"),J=document.getElementById("preview-content"),Y=document.getElementById("close-preview"),_=document.getElementById("autosave-indicator"),I=document.getElementById("autosave-text"),G=document.getElementById("last-saved"),Z=document.getElementById("save-time"),S=document.getElementById("title"),i=document.getElementById("slug"),E=document.getElementById("author"),v=document.getElementById("description"),ee=document.getElementById("draft"),te=document.getElementById("comments-enabled"),re=document.getElementById("featured"),V=document.getElementById("char-count"),d={title:e=>e.trim()?e.length<5?"El título debe tener al menos 5 caracteres":e.length>100?"El título no puede exceder 100 caracteres":!0:"El título es obligatorio",author:e=>e.trim()?e.length<2?"El nombre del autor debe tener al menos 2 caracteres":e.length>50?"El nombre del autor no puede exceder 50 caracteres":!0:"El autor es obligatorio",image:e=>{if(!e.trim())return"La URL de la imagen es obligatoria";try{return new URL(e),!0}catch{return"Debe ser una URL válida"}},description:e=>e.trim()?e.length<10?"La descripción debe tener al menos 10 caracteres":e.length>160?"La descripción no puede exceder 160 caracteres":!0:"La descripción es obligatoria",content:e=>e.trim()?e.length<50?"El contenido debe tener al menos 50 caracteres":!0:"El contenido es obligatorio",slugForSubmit:async e=>{if(!e.trim())return"El slug es obligatorio";if(!/^[a-z0-9-]+$/.test(e))return"El slug solo puede contener letras minúsculas, números y guiones";if(e.length<3)return"El slug debe tener al menos 3 caracteres";if(e.length>100)return"El slug no puede exceder 100 caracteres";try{console.log("[SLUG VALIDATION SUBMIT] Validando slug:",e),console.log("[SLUG VALIDATION SUBMIT] currentDraftId:",p);const t=p||void 0;console.log("[SLUG VALIDATION SUBMIT] excludeId:",t);const r=await be(e,t);if(console.log("[SLUG VALIDATION SUBMIT] Slug exists:",r),r)return"Este slug ya está en uso"}catch(t){console.warn("No se pudo verificar el slug:",t)}return!0}},N=async(e,t,r)=>{if(!e||!r)return!0;const o=await r(e.value);if(o!==!0){const a=e;return a.classList&&(a.classList.remove("border-green-600"),a.classList.add("border-red-500")),t&&(t.textContent=o,t.classList.remove("hidden")),!1}else{const a=e;return a.classList&&(a.classList.remove("border-red-500"),a.classList.add("border-green-600")),t&&t.classList.add("hidden"),!0}},oe=e=>e.toLowerCase().replace(/[^\w\sáéíóúüñ]/g,"").replace(/\s+/g,"-").replace(/á/g,"a").replace(/é/g,"e").replace(/í/g,"i").replace(/ó/g,"o").replace(/ú|ü/g,"u").replace(/ñ/g,"n").replace(/-+/g,"-").trim(),$=()=>{if(V&&v){const e=v.value.length;V.textContent=e.toString(),V.className=e>140?"text-yellow-400":e>160?"text-red-400":"text-gray-400"}},we=(e="Guardando borrador...")=>{_&&I&&(I.textContent=e,_.classList.remove("hidden"))},ne=()=>{_&&setTimeout(()=>{_.classList.add("hidden")},2e3)},Ie=()=>{if(G&&Z){const e=new Date;Z.textContent=e.toLocaleTimeString(),G.classList.remove("hidden")}},q=async(e=!0)=>{if(c){e&&we();try{const t={title:n.title,slug:n.slug,author:n.author,description:n.description,content:n.content,image:n.image,tags:n.tags,draft:!0,commentsEnabled:n.commentsEnabled,featured:n.featured};p=await le(t,p||void 0),e&&(I&&(I.textContent="Borrador guardado"),Ie(),ne()),c=!1}catch(t){console.error("Error al guardar borrador:",t),e&&I&&(I.textContent="Error al guardar",ne())}}},h=()=>{D&&clearTimeout(D),D=window.setTimeout(()=>q(),3e3)},xe=()=>{S&&i&&(S.addEventListener("input",()=>{const e=S.value,t=S.dataset.lastValue||"";(!i.value||t===i.value)&&(i.value=oe(e),n.slug=i.value,c=!0),S.dataset.lastValue=i.value,n.title=e,h()}),i.addEventListener("input",()=>{i.value=oe(i.value),n.slug=i.value,c=!0,h()}),i.addEventListener("blur",()=>{console.log("[SLUG BLUR] Validando slug en blur:",i.value),N(i,document.getElementById("slug-error"),d.slugForSubmit)}))},Be=()=>{E&&(E.addEventListener("input",()=>{n.author=E.value,c=!0,h()}),E.addEventListener("blur",()=>{N(E,document.getElementById("author-error"),d.author)})),v&&(v.addEventListener("input",()=>{n.description=v.value,$(),c=!0,h()}),v.addEventListener("blur",()=>{N(v,document.getElementById("description-error"),d.description)})),[ee,te,re].forEach(e=>{e&&e.addEventListener("change",()=>{e===ee&&(n.draft=e.checked),e===te&&(n.commentsEnabled=e.checked),e===re&&(n.featured=e.checked),c=!0,h()})})},Se=()=>{const e=document.getElementById("rich-text-editor-container");if(e){const o=document.createElement("textarea");o.id="content",o.rows=20,o.className="w-full px-4 py-2 bg-green-700/50 border border-green-600 rounded-md focus:outline-none focus:ring-2 focus:ring-green-400 text-white font-mono transition-colors resize-y",o.placeholder="Escribe tu contenido aquí usando Markdown...",o.addEventListener("input",()=>{n.content=o.value,c=!0,h();const a=o.value.split(/\s+/).filter(l=>l.length>0).length;let s=e.querySelector(".word-counter");s||(s=document.createElement("div"),s.className="word-counter absolute bottom-2 right-2 text-xs text-gray-400 bg-green-900/80 px-2 py-1 rounded",e.style.position="relative",e.appendChild(s)),s.textContent=`${a} palabras`}),o.addEventListener("blur",()=>{N({value:n.content},document.getElementById("content-error"),d.content)}),e.appendChild(o)}const t=document.getElementById("image-uploader-container");if(t){const o=document.createElement("div");o.className="space-y-2";const a=document.createElement("label");a.className="block text-white text-sm font-medium",a.innerHTML='URL de imagen destacada <span class="text-red-400">*</span>';const s=document.createElement("input");s.type="url",s.className="w-full px-4 py-2 bg-green-700/50 border border-green-600 rounded-md focus:outline-none focus:ring-2 focus:ring-green-400 text-white transition-colors",s.placeholder="https://example.com/imagen.jpg",s.value=n.image,s.addEventListener("input",()=>{n.image=s.value,c=!0,h()}),s.addEventListener("blur",()=>{N(s,document.getElementById("image-error"),d.image)}),o.appendChild(a),o.appendChild(s),t.appendChild(o)}const r=document.getElementById("tags-input-container");if(r){const o=document.createElement("div");o.className="space-y-2";const a=document.createElement("input");a.type="text",a.className="w-full px-4 py-2 bg-green-700/50 border border-green-600 rounded-md focus:outline-none focus:ring-2 focus:ring-green-400 text-white transition-colors",a.placeholder="umbanda, espiritualidad, etc. (separadas por comas)";const s=document.createElement("div");s.className="flex flex-wrap gap-2";const l=()=>{const g=a.value.split(",").map(f=>f.trim()).filter(f=>f);n.tags=g,s.innerHTML="",g.forEach(f=>{const b=document.createElement("span");b.className="px-2 py-1 bg-green-600 text-white text-xs rounded-full",b.textContent=f,s.appendChild(b)})};a.addEventListener("input",()=>{l(),c=!0,h()}),o.appendChild(a),o.appendChild(s),r.appendChild(o)}},Te=async e=>{if(e.preventDefault(),!await Ce()){B&&R&&(R.textContent="Por favor, corrige los errores en el formulario.",B.classList.remove("hidden"));return}L&&(L.disabled=!0,L.innerHTML=`
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Guardando...</span>
      `),[M,B,T].forEach(r=>{r&&r.classList.add("hidden")});try{const r={...n,publishDate:Ee.fromDate(new Date)};if(await ye(r),p)try{await de(p),p=null}catch(o){console.warn("No se pudo eliminar el borrador:",o)}M&&j&&(j.href=`/blog/${r.slug}`,M.classList.remove("hidden"),!r.draft&&w?w.style.display="inline":w&&(w.style.display="none"),A&&typeof A.reset=="function"&&A.reset(),n={title:"",slug:"",author:"",image:"",description:"",tags:[],content:"",draft:!1,commentsEnabled:!0,featured:!1},c=!1,$(),G&&G.classList.add("hidden"))}catch(r){if(console.error("Error al guardar artículo:",r),B&&R){const o=r instanceof Error?r.message:"Ha ocurrido un error inesperado.";R.textContent=o,B.classList.remove("hidden")}}finally{L&&(L.disabled=!1,L.innerHTML="<span>Publicar artículo</span>")}},Ce=async()=>{const e=[{value:n.title,error:document.getElementById("title-error"),validator:d.title},{value:n.slug,error:document.getElementById("slug-error"),validator:d.slugForSubmit},{value:n.author,error:document.getElementById("author-error"),validator:d.author},{value:n.image,error:document.getElementById("image-error"),validator:d.image},{value:n.description,error:document.getElementById("description-error"),validator:d.description},{value:n.content,error:document.getElementById("content-error"),validator:d.content}];let t=!0;for(const{value:r,error:o,validator:a}of e){const s=await a(r);s!==!0?(o&&(o.textContent=s,o.classList.remove("hidden")),t=!1):o&&o.classList.add("hidden")}return t},De=()=>{if(!(!J||!m))try{const e=n.title||"Sin título",t=n.author||"Sin autor",r=n.description||"Sin descripción",o=n.content||"*No hay contenido para mostrar*",a=n.image;if(typeof window<"u"&&window.marked&&window.DOMPurify){const s=window.DOMPurify.sanitize(window.marked.parse(o));let l=`
          <div class="mb-6">
            <h1 class="text-3xl font-bold text-white mb-2">${e}</h1>
            <p class="text-gray-300 mb-4">Por ${t}</p>
            <p class="text-gray-400 italic">${r}</p>
          </div>
        `;a&&(l+=`
            <div class="mb-6">
              <img src="${a}" alt="${e}" class="w-full h-64 object-cover rounded-lg" />
            </div>
          `),l+=`<div class="prose prose-invert prose-green max-w-none">${s}</div>`,J.innerHTML=l,m.classList.remove("hidden")}else alert("Las librerías de vista previa no están disponibles.")}catch(e){console.error("Error al generar vista previa:",e),alert("Error al generar la vista previa.")}},Ae=async()=>{if(!(!T||!k)){T.classList.remove("hidden"),k.textContent="Iniciando sincronización...";try{await Le({forceSync:!0}),k.textContent="Sincronización completada exitosamente.",setTimeout(()=>{T&&T.classList.add("hidden")},3e3)}catch(e){console.error("Error en sincronización:",e);const t=e instanceof Error?e.message:"Error desconocido";k.textContent=`Error: ${t}`}}},Ue=async()=>{if(console.log("[CLEANUP] Iniciando limpieza de borradores duplicados..."),!n.slug){alert("No hay slug para limpiar");return}try{await ce(n.slug,p||void 0),alert("✅ Borradores duplicados eliminados exitosamente!")}catch(e){console.error("[CLEANUP] Error al limpiar borradores:",e),alert("❌ Error al limpiar borradores: "+(e instanceof Error?e.message:"Error desconocido"))}},Ne=()=>{A&&A.addEventListener("submit",Te),Q&&Q.addEventListener("click",De),W&&W.addEventListener("click",()=>q(!0)),w&&w.addEventListener("click",Ae);const e=document.getElementById("debug-auth-btn");e&&e.addEventListener("click",ue);const t=document.getElementById("test-firestore-btn");t&&t.addEventListener("click",ke);const r=document.getElementById("cleanup-drafts-btn");r&&r.addEventListener("click",Ue),Y&&m&&(Y.addEventListener("click",()=>{m.classList.add("hidden")}),m.addEventListener("click",o=>{o.target===m&&m.classList.add("hidden")})),document.addEventListener("keydown",o=>{o.key==="Escape"&&m&&!m.classList.contains("hidden")&&m.classList.add("hidden")})},ue=async()=>{if(console.log("[DEBUG] Verificando estado de autenticación..."),!F.currentUser){console.error("[DEBUG] No hay usuario autenticado");return}const e=F.currentUser;console.log("[DEBUG] Usuario autenticado:",{uid:e.uid,email:e.email,displayName:e.displayName,emailVerified:e.emailVerified});try{const t=await e.getIdToken(!0);console.log("[DEBUG] Token obtenido exitosamente, longitud:",t.length);const r=JSON.parse(atob(t.split(".")[1]));console.log("[DEBUG] Token payload:",{email:r.email,email_verified:r.email_verified,iss:r.iss,aud:r.aud,exp:new Date(r.exp*1e3),iat:new Date(r.iat*1e3)})}catch(t){console.error("[DEBUG] Error al obtener token:",t)}},ke=async()=>{if(console.log("[TEST] Probando conectividad con Firestore..."),!F.currentUser){console.error("[TEST] No hay usuario autenticado"),alert("No hay usuario autenticado");return}try{const e={title:"Test Draft",slug:"test-draft-"+Date.now(),author:"Test Author",description:"Test description",content:"Test content",image:"https://via.placeholder.com/400x300",tags:["test"],draft:!0,commentsEnabled:!0,featured:!1};console.log("[TEST] Intentando guardar borrador de prueba...");const t=await le(e);console.log("[TEST] Borrador guardado exitosamente con ID:",t),console.log("[TEST] Intentando leer borrador...");const r=await ve(t);console.log("[TEST] Borrador leído exitosamente:",r),console.log("[TEST] Intentando eliminar borrador de prueba..."),await de(t),console.log("[TEST] Borrador eliminado exitosamente"),alert("✅ Todas las pruebas de Firestore pasaron exitosamente!")}catch(e){console.error("[TEST] Error en prueba de Firestore:",e),alert("❌ Error en prueba de Firestore: "+(e instanceof Error?e.message:"Error desconocido"))}};pe(F,async e=>{e&&(await ue(),K&&K.classList.add("hidden"),X&&X.classList.remove("hidden"),xe(),Be(),Ne(),Se(),$(),e.displayName&&E&&!E.value&&(E.value=e.displayName,n.author=e.displayName))});window.addEventListener("beforeunload",()=>{D&&clearTimeout(D),c&&q(!1)});

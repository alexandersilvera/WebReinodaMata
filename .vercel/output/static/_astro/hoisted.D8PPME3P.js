import{o as F,a as E,d as S,b as B,g as $,r as O,t as z,v as G,s as M,m as J,x as W}from"./config.DlMdeYpO.js";import"./hoisted.D3FFN0QM.js";let c=null,l=null,b=!1,m=null,d={};function j(){console.log("[Perfil] Inicializando página de perfil...");const U=document.getElementById("loading-state"),p=document.getElementById("logged-out-state"),v=document.getElementById("profile-form-container"),P=document.getElementById("profile-form"),i=document.getElementById("display-name"),h=document.getElementById("email"),f=document.getElementById("bio"),s=document.getElementById("avatar-preview"),y=document.getElementById("avatar-upload"),u=document.getElementById("save-button"),a=document.getElementById("upload-status"),r=document.getElementById("status-message"),x=document.getElementById("status-text");function g(n,t=!1){if(!r||!x)return;if(!n){r.classList.add("hidden");return}x.textContent=n,r.className="mt-4 p-3 rounded-lg",r.classList.toggle("bg-red-600/80",t),r.classList.toggle("text-red-100",t),r.classList.toggle("bg-green-600/80",!t),r.classList.toggle("text-green-100",!t),r.classList.remove("hidden");const e=x;e&&(e.classList.toggle("text-red-400",t),e.classList.toggle("text-green-400",!t),setTimeout(()=>{e.classList.add("hidden"),e.textContent=""},4e3))}async function N(n){if(!i||!f||!s)return;const t=S(B,"userProfiles",n);try{const e=await $(t);e.exists()?(d=e.data(),i.value=d.displayName||"",f.value=d.bio||"",s.src=d.photoURL||"/images/default-avatar.png"):(i.value=E.currentUser?.displayName||"",s.src=E.currentUser?.photoURL||"/images/default-avatar.png",d={displayName:i.value,photoURL:s.src,bio:""})}catch(e){console.error("[Perfil] Error loading user profile:",e),g("Error al cargar el perfil.",!0),s.src="/images/default-avatar.png"}}const C=n=>{if(!y||!s)return;const t=n.target.files;if(t&&t.length>0){const e=t[0];l=e;const L=new FileReader;L.onload=o=>{s&&(s.src=o.target?.result)},L.readAsDataURL(l),a&&(a.textContent=`Seleccionado: ${e.name.substring(0,20)}...`)}else l=null},R=async n=>{if(n.preventDefault(),!c||b||!u||!i||!f)return;b=!0,u.disabled=!0,u.textContent="Guardando...",g(""),a&&!l&&(a.textContent="");let t=d.photoURL||E.currentUser?.photoURL||null;if(l){a&&(a.textContent="Subiendo avatar...");const D=`avatar.${l.name.split(".").pop()}`,A=`userProfiles/${c}/${D}`,T=O(W,A);try{const w=await z(T,l);t=await G(w.ref),a&&(a.textContent="Avatar subido."),l=null}catch(w){console.error("[Perfil] Error uploading avatar:",w),g("Error al subir el avatar.",!0),a&&(a.textContent="Error al subir."),b=!1,u.disabled=!1,u.textContent="Guardar Cambios";return}}const e={displayName:i.value.trim()||"Usuario Anónimo",bio:f.value.trim(),photoURL:t,updatedAt:M()};s&&(s.src=t||"/images/default-avatar.png");try{const o={uid:c,photoURL:t,displayName:e.displayName,timestamp:new Date().getTime()};localStorage.setItem("userProfileData",JSON.stringify(o)),console.log("[Perfil] Datos de perfil guardados en localStorage para persistencia:",o)}catch(o){console.warn("[Perfil] No se pudo guardar en localStorage:",o)}const L=S(B,"userProfiles",c);try{await J(L,e,{merge:!0}),d={...d,...e},g("Perfil guardado con éxito!");for(let o=0;o<3;o++)setTimeout(()=>{window.dispatchEvent(new CustomEvent("profileUpdated",{detail:{photoURL:e.photoURL,displayName:e.displayName,userId:c,timestamp:new Date().getTime()}})),console.log(`[Perfil] Evento profileUpdated #${o+1} disparado con:`,e.photoURL)},300*(o+1))}catch(o){console.error("[Perfil] Error saving profile:",o),g("Error al guardar el perfil.",!0)}finally{b=!1,u.disabled=!1,u.textContent="Guardar Cambios",a&&!a.textContent?.includes("Error")&&setTimeout(()=>{a&&(a.textContent="")},3e3)}};m&&m(),m=F(E,async n=>{U&&U.classList.add("hidden"),n?(c=n.uid,v&&v.classList.remove("hidden"),p&&p.classList.add("hidden"),h&&(h.value=n.email||""),await N(n.uid)):(c=null,v&&v.classList.add("hidden"),p&&p.classList.remove("hidden"),i&&(i.value=""),h&&(h.value=""),f&&(f.value=""),s&&(s.src="/images/default-avatar.png"),a&&(a.textContent=""))}),y?(y.removeEventListener("change",C),y.addEventListener("change",C)):console.warn("[Perfil] Avatar upload input not found, listener not attached."),P?(P.removeEventListener("submit",R),P.addEventListener("submit",R)):console.warn("[Perfil] Profile form not found, listener not attached.")}function I(){window.location.pathname==="/perfil"||window.location.pathname.startsWith("/perfil/")?j():m&&(m(),m=null)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",I):I();document.addEventListener("astro:page-load",I);

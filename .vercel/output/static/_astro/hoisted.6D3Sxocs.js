import{d as $,b as L,g as X,s as J,u as K,i as Y,q as Z,w as _,n as ee}from"./config.DlMdeYpO.js";import"https://cdn.jsdelivr.net/npm/dompurify@2.3.4/dist/purify.min.js";import"https://cdn.jsdelivr.net/npm/marked/marked.min.js";import"./hoisted.D3FFN0QM.js";let h,P={},i=[],a=!1,p=null;const te=document.getElementById("loading"),ne=document.getElementById("article-form-container"),ae=document.getElementById("article-form"),I=document.getElementById("autosave-indicator"),g=document.getElementById("autosave-text"),N=document.getElementById("last-saved"),F=document.getElementById("save-time"),w=document.getElementById("success-message"),T=document.getElementById("error-message"),R=document.getElementById("error-details"),O=document.getElementById("view-article-link"),s=document.getElementById("preview-modal"),j=document.getElementById("preview-content"),oe=document.getElementById("close-preview"),x=document.getElementById("submit-btn"),S=document.getElementById("char-count"),G=document.getElementById("word-counter"),c=document.getElementById("title"),o=document.getElementById("slug"),E=document.getElementById("author"),m=document.getElementById("excerpt"),l=document.getElementById("content"),y=document.getElementById("featuredImage"),b=document.getElementById("category"),B=document.getElementById("published"),C=document.getElementById("featured"),k=document.getElementById("commentsEnabled"),A=document.getElementById("tags-input"),M=document.getElementById("tags-display"),V=window.location.pathname.split("/");h=V[V.length-1];function f(e){T&&R&&(R.textContent=e,T.classList.remove("hidden"),setTimeout(()=>{T.classList.add("hidden")},5e3))}function re(e){w&&(w.querySelector("p").textContent=e,w.classList.remove("hidden"),setTimeout(()=>{w.classList.add("hidden")},5e3))}function z(e){return e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s-]/g,"").trim().replace(/\s+/g,"-").replace(/-+/g,"-")}function Q(){if(S&&m){const e=m.value.length;S.textContent=e.toString(),S.className=e>140?"text-yellow-400":e>160?"text-red-400":"text-gray-400"}}function U(){if(G&&l){const e=l.value.split(/\s+/).filter(t=>t.length>0).length;G.textContent=`${e} palabras`}}function se(e="Guardando cambios..."){I&&g&&(g.textContent=e,I.classList.remove("hidden"))}function W(){I&&setTimeout(()=>{I.classList.add("hidden")},2e3)}function ce(){if(N&&F){const e=new Date;F.textContent=e.toLocaleTimeString(),N.classList.remove("hidden")}}function ie(e){const t=e.trim().toLowerCase();t&&!i.includes(t)&&(i.push(t),q(),a=!0,r())}function le(e){i=i.filter(t=>t!==e),q(),a=!0,r()}function q(){M&&(M.innerHTML="",i.forEach(e=>{const t=document.createElement("span");t.className="inline-flex items-center px-3 py-1 bg-green-600 text-white text-sm rounded-full",t.innerHTML=`
          ${e}
          <button type="button" class="ml-2 text-green-200 hover:text-white" onclick="removeTag('${e}')">
            <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        `,M.appendChild(t)}))}async function H(){if(a){se();try{const e=$(L,"articles",h),t={title:c.value,slug:o.value,author:E.value,excerpt:m.value,content:l.value,featuredImage:y.value,category:b.value,tags:i,published:B.checked,featured:C.checked,commentsEnabled:k.checked,updatedAt:J()};await K(e,t),g&&(g.textContent="Cambios guardados"),ce(),W(),a=!1}catch(e){console.error("Error al guardar borrador:",e),g&&(g.textContent="Error al guardar"),W()}}}function r(){p&&clearTimeout(p),p=window.setTimeout(()=>H(),3e3)}async function de(e){try{const t=Y(L,"articles"),n=Z(t,_("slug","==",e));return(await ee(n)).docs.some(d=>d.id!==h)}catch(t){return console.error("Error checking slug:",t),!1}}async function ue(){try{const e=$(L,"articles",h),t=await X(e);if(t.exists()){const n=t.data();P=n,c.value=n.title||"",o.value=n.slug||"",E.value=n.author||"",m.value=n.excerpt||"",l.value=n.content||"",y.value=n.featuredImage||"",b.value=n.category||"",B.checked=n.published||!1,C.checked=n.featured||!1,k.checked=n.commentsEnabled!==!1,i=n.tags||[],q(),Q(),U();const v=document.getElementById("created-date"),d=document.getElementById("updated-date"),u=document.getElementById("status-badge");v&&n.publishDate&&(v.textContent=new Date(n.publishDate.toDate()).toLocaleDateString()),d&&n.updatedAt&&(d.textContent=new Date(n.updatedAt.toDate()).toLocaleDateString()),u&&(n.published?(u.textContent="Publicado",u.className="px-2 py-1 text-xs font-medium rounded-full bg-green-600 text-white"):(u.textContent="Borrador",u.className="px-2 py-1 text-xs font-medium rounded-full bg-yellow-600 text-white")),te?.classList.add("hidden"),ne?.classList.remove("hidden")}else f("Artículo no encontrado"),setTimeout(()=>{window.location.href="/admin/articles"},2e3)}catch(e){console.error("Error loading article:",e),f("Error al cargar el artículo: "+(e instanceof Error?e.message:"Error desconocido"))}}async function me(e){if(e.preventDefault(),!c.value.trim()||!l.value.trim()){f("El título y el contenido son requeridos");return}if(o.value!==P.slug&&await de(o.value)){f("El slug ya existe. Por favor, elige otro.");return}x.disabled=!0,x.innerHTML=`
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span>Actualizando...</span>
    `;try{const t=$(L,"articles",h),n={title:c.value.trim(),slug:o.value.trim(),author:E.value.trim(),excerpt:m.value.trim(),content:l.value.trim(),featuredImage:y.value.trim(),category:b.value,tags:i,published:B.checked,featured:C.checked,commentsEnabled:k.checked,updatedAt:J()};await K(t,n),O&&(O.href=`/blog/${n.slug}`),re("¡Artículo actualizado con éxito!"),a=!1}catch(t){console.error("Error updating article:",t),f("Error al actualizar el artículo: "+(t instanceof Error?t.message:"Error desconocido"))}finally{x.disabled=!1,x.innerHTML="<span>Actualizar artículo</span>"}}function ge(){if(!(!j||!s))try{const e=c.value||"Sin título",t=E.value||"Sin autor",n=m.value||"Sin descripción",v=l.value||"*No hay contenido para mostrar*",d=y.value;if(typeof window<"u"&&window.marked&&window.DOMPurify){const u=window.DOMPurify.sanitize(window.marked.parse(v));let D=`
          <div class="mb-6">
            <h1 class="text-3xl font-bold text-white mb-2">${e}</h1>
            <p class="text-gray-300 mb-4">Por ${t}</p>
            <p class="text-gray-400 italic">${n}</p>
          </div>
        `;d&&(D+=`
            <div class="mb-6">
              <img src="${d}" alt="${e}" class="w-full h-64 object-cover rounded-lg" />
            </div>
          `),D+=`<div class="prose prose-invert prose-green max-w-none">${u}</div>`,j.innerHTML=D,s.classList.remove("hidden")}else alert("Las librerías de vista previa no están disponibles.")}catch(e){console.error("Error al generar vista previa:",e),alert("Error al generar la vista previa.")}}function ve(){ae.addEventListener("submit",me),c.addEventListener("input",()=>{a=!0,r()}),o.addEventListener("input",()=>{o.value=z(o.value),a=!0,r()}),E.addEventListener("input",()=>{a=!0,r()}),m.addEventListener("input",()=>{Q(),a=!0,r()}),l.addEventListener("input",()=>{U(),a=!0,r()}),y.addEventListener("input",()=>{a=!0,r()}),b.addEventListener("change",()=>{a=!0,r()}),[B,C,k].forEach(e=>{e.addEventListener("change",()=>{a=!0,r()})}),c.addEventListener("input",()=>{(!o.value||o.value===z(P.title||""))&&(o.value=z(c.value))}),A.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),ie(A.value),A.value="")}),document.getElementById("preview-btn")?.addEventListener("click",ge),document.getElementById("save-draft-btn")?.addEventListener("click",()=>H()),oe?.addEventListener("click",()=>{s?.classList.add("hidden")}),s?.addEventListener("click",e=>{e.target===s&&s.classList.add("hidden")}),document.addEventListener("keydown",e=>{e.key==="Escape"&&s&&!s.classList.contains("hidden")&&s.classList.add("hidden")})}window.removeTag=le;ve();ue();window.addEventListener("beforeunload",()=>{p&&clearTimeout(p),a&&H()});
